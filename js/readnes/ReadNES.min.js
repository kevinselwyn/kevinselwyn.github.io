/*! ReadNES.js - v1.0 - 2013-10-29
* http://kevinselwyn.com/
* Copyright (c) 2013 Kevin Selwyn; Licensed GPLv3 */
(function(document,window,undefined){"use strict";var ReadNES={rom:{size:0,header:{prg:"",chr:"",mapper:"",mapper1:"",reserved:""},prg:16384,chr:8192,data:{main:"",name:"",chr:"",prg:""}},output:[],vars:{chars:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",cursor:0,reader:{},file:{}},el:{drag:document.getElementById("drag"),input:document.getElementById("input"),output:document.getElementById("output"),message:document.getElementById("message"),prg:document.getElementById("prg"),chr:document.getElementById("chr")},util:{support:function(){return typeof FileReader!="undefined"},error:function(e){if(Error)throw new Error(e);return alert(e),!1},printf:function(){var e=ReadNES,t=[],n="",r=0,i=0;for(r=0,i=arguments.length;r<i;r+=1)t.push(arguments[r]);n=t[0];for(r=1,i=t.length;r<i;r+=1)n=n.replace(/%\w{1}/,t[r]);return e.output.push(n),this},dec2hex:function(e){var t=0,n="";return t=e.charCodeAt(0),n=t.toString(16).toUpperCase(),n},hex2dec:function(e){var t=0,n="";return t=parseInt(e.toLowerCase(),16),n=String.fromCharCode(t),n},index:function(e){var t=ReadNES,n=t.vars.chars,r=0,i=0;for(r=0,i=n.length;r<i;r+=1)if(n[r]===e)return r;return 0},base64_encode:function(e){var t=ReadNES,n="",r=[],i=[],s=0,o=0,u=0;while(s<e.length){r[0]=e.charCodeAt(s),r[1]=e.charCodeAt(s+1),r[2]=e.charCodeAt(s+2),s+=3,i[0]=r[0]>>2,i[1]=(r[0]&3)<<4|r[1]>>4,i[2]=(r[1]&15)<<2|r[2]>>6,i[3]=r[2]&63,isNaN(r[1])?i[2]=i[3]=64:isNaN(r[2])&&(i[3]=64);for(o=0,u=4;o<u;o+=1)n+=t.vars.chars[i[o]]}return n},base64_decode:function(e){var t=ReadNES,n="",r=[],i=[],s=0;while(s<e.length)i[0]=t.util.index(e[s]),i[1]=t.util.index(e[s+1]),i[2]=t.util.index(e[s+2]),i[3]=t.util.index(e[s+3]),s+=4,r[0]=i[0]<<2|i[1]>>4,r[1]=(i[1]&15)<<4|i[2]>>2,r[2]=(i[2]&3)<<6|i[3],n+=String.fromCharCode(r[0]),i[2]!==64&&(n+=String.fromCharCode(r[1])),i[3]!==64&&(n+=String.fromCharCode(r[2]));return n},extension:function(e,t){var n=e.split(".");return n[n.length-1]=t,n.join(".")},str_repeat:function(e,t){return(new Array(parseInt(t,10)+1)).join(e)},json:function(str){return JSON.parse!=="undefined"?JSON.parse(str):(str=str===""?'""':str,eval("("+str+");"))}},extend:function(e){var t=0;for(t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);return this},trigger:function(e){var t=new CustomEvent(e);return document.dispatchEvent(t),this},drag:{over:function(e){return e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="copy",this.className="over",!1},drop:function(e){var t=e.dataTransfer||e.target,n=ReadNES;return n.vars.file=t.files[0],n.rom.data.name=t.files[0].name,n.trigger("file/read"),this.className="",e.stopPropagation(),e.preventDefault(),!1}},events:function(){var e=this.el.drag,t=this.el.input;return e.addEventListener("dragover",this.drag.over,!1),e.addEventListener("drop",this.drag.drop,!1),t.addEventListener("change",this.drag.drop,!1),document.addEventListener("file/read",this.read,!1),document.addEventListener("file/loaded",this.loaded,!1),this},read:function(){var e=ReadNES,t=new FileReader,n=e.vars.file;return t.onloadend=function(t){t.target.readyState===FileReader.DONE&&(e.rom.data.main=t.target.result,e.trigger("file/loaded"))},t.readAsBinaryString(n),this},loaded:function(){var e=ReadNES,t=e.parse,n=0;for(n in t)t.hasOwnProperty(n)&&t[n].call()},parse:{size:function(){var e=ReadNES,t=e.rom.data.main;return e.util.printf("File length: %d Bytes",t.length),e.rom.size=t.length,this},magic:function(){var e=ReadNES,t=e.vars.cursor,n=e.rom.data.main;return(n[t++]!=="N"||n[t++]!=="E"||n[t++]!=="S"||n[t++]!==e.util.hex2dec("1A"))&&e.util.error("Bad header"),e.vars.cursor=t,this},header:function(){var e=ReadNES,t=e.vars.cursor,n=e.rom.data.main,r={},i=0,s=0;r={prg:n[t++],chr:n[t++],mapper:n[t++],mapper1:n[t++],reserved:""};for(i=0,s=8;i<s;i+=1)r.reserved+=n[t++];return e.util.printf("NES PRG: %d CHR: %d MAPPER: %d %d",r.prg.charCodeAt(0),r.chr.charCodeAt(0),r.mapper.charCodeAt(0),r.mapper1.charCodeAt(0)),e.vars.cursor=t,e.rom.header=r,this},mapper:function(){var e=ReadNES,t=e.rom.header.mapper.charCodeAt(0),n=[];switch(t>>4){case 0:n.push("No mapper"),e.util.printf("No mapper");break;case 1:e.util.printf("Nintendo MMC1");break;case 2:e.util.printf("PRG Switch (konami)");break;case 3:e.util.printf("VROM (CHR) Switch");break;case 4:e.util.printf("Nintendo MMC3");break;case 5:e.util.printf("Nintendo MMC5");break;default:e.util.printf("Mapper number: %d",t>>4)}return this},flags:function(){var e=ReadNES,t=e.rom.header.mapper&e.util.hex2dec("0F").charCodeAt(0);e.util.printf("Flags: %d",t);switch(t){case 0:e.util.printf("H");break;case 1:e.util.printf("V");break;case 2:e.util.printf("H + Bat");break;case 3:e.util.printf("V + Bat");break;default:}return this},split:function(){var e=ReadNES,t=e.rom,n=e.rom.data.main,r=e.vars.cursor,i={data:"",header:parseInt(e.rom.header.prg.charCodeAt(0),10),length:e.rom.prg},s={data:"",header:parseInt(e.rom.header.chr.charCodeAt(0),10),length:e.rom.chr},o=0,u=0;i.length*=i.header,s.length*=s.header,e.util.printf("PRG %d page%d of 16kb (%d bytes)",i.header,i.header>1?"s":"",i.length),e.util.printf("CHR %d page%d of 8kb (%d bytes)",s.header,s.header>1?"s":"",s.length);for(o=0,u=i.length;o<u;o+=1)i.data+=n[r++];for(o=0,u=s.length;o<u;o+=1)s.data+=n[r++];return e.util.printf("End at %d",r),e.util.printf("Remaining bytes: %d",t.size-r),e.rom.data.prg=i.data,e.rom.data.chr=s.data,this},output:function(){var e=ReadNES,t=e.rom,n=e.output,r=[],i=[],s=[],o=e.el.message;s[0]=e.util.str_repeat(t.data.prg,e.el.prg.value),s[1]=e.util.str_repeat(t.data.chr,e.el.chr.value),r[0]=o.getElementsByTagName("a")[0],i[0]=o.getElementsByTagName("a")[1],r[0].href="data:application/octet-stream;base64,"+e.util.base64_encode(s[0]),i[0].href="data:application/octet-stream;base64,"+e.util.base64_encode(s[1]),r[1]=document.createTextNode(e.util.extension(t.data.name,"prg")),i[1]=document.createTextNode(e.util.extension(t.data.name,"chr")),r[0].appendChild(r[1]),i[0].appendChild(i[1]),o.getElementsByTagName("p")[0].innerHTML=n.join("<br />"),o.className="show"}},init:function(){return this.util.support()||ReadNESshiv.init(),this.events(),!0}};window.ReadNESshiv=window.ReadNESshiv||{init:function(){ReadNES.util.error("ReadNESshiv has not been activated")}},typeof module=="object"&&module&&typeof module.exports=="object"?module.exports=ReadNES:(window.ReadNES=ReadNES,typeof define=="function"&&define.amd&&define("ReadNES",[],function(){return ReadNES}))})(document,window);